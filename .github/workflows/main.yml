name: CherryOS CI/CD Pipeline

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 2,14 * * *' 
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # 1. Data Sync & Quality
  data-and-quality:
    name: Sync Data & Quality Gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Refresh Data Mirror
        env:
          VITE_STEAM_ID: "76561198043191125"
          VITE_AL_ID: "36296"
          VITE_AL_TOKEN: ${{ secrets.ANILIST_TOKEN }}
          VITE_PROXY_URL: ${{ secrets.VITE_PROXY_URL }}
        run: |
          mkdir -p src/data/mirror
          node -e "
          const fs = require('fs');
          const https = require('https');
          async function request(url, opts = {}) {
            return new Promise((res, rej) => {
              const req = https.request(url, opts, (r) => {
                let b = ''; r.on('data', c => b += c); r.on('end', () => res(JSON.parse(b)));
              });
              req.on('error', rej); if (opts.body) req.write(opts.body); req.end();
            });
          }
          async function run() {
            try {
              const ani = await request('https://graphql.anilist.co', {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + process.env.VITE_AL_TOKEN },
                body: JSON.stringify({ query: 'query(\$userId:Int){MediaListCollection(userId:\$userId,type:ANIME){lists{entries{media{id title{english romaji}coverImage{extraLarge}averageScore type status}score(format:POINT_10)progress status}}}MangaList:MediaListCollection(userId:\$userId,type:MANGA){lists{entries{media{id title{english romaji}coverImage{extraLarge}averageScore type status}score(format:POINT_10)progress status}}}}', variables: { userId: Number(process.env.VITE_AL_ID) } })
              });
              fs.writeFileSync('src/data/mirror/anilist.json', JSON.stringify(ani));
              const steam = await request(process.env.VITE_PROXY_URL + '/steam?steamId=' + process.env.VITE_STEAM_ID);
              fs.writeFileSync('src/data/mirror/steam.json', JSON.stringify(steam));
              fs.writeFileSync('src/data/mirror/metadata.json', JSON.stringify({ lastUpdated: new Date().toISOString() }));
            } catch (e) { console.error(e); process.exit(1); }
          }
          run();"

      - name: Commit Fresh Data
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add src/data/mirror/*.json
          git diff --staged --quiet || (git commit -m "chore: refresh data mirror [skip ci]" && git push origin main)

      - name: Run Linter
        run: npm run lint

      - name: Run Tests
        run: npm test -- --run

  # 2. Parallel Build Jobs
  build-web:
    name: Build Web Assets
    needs: data-and-quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { ref: main }
      - uses: actions/setup-node@v4
        with: { node-version: '20', cache: 'npm' }
      - run: npm ci
      - name: Build
        env:
          VITE_PROXY_URL: ${{ secrets.VITE_PROXY_URL }}
          VITE_WEATHER_API_KEY: ${{ secrets.VITE_WEATHER_API_KEY }}
          VITE_OCI_NAMESPACE: ${{ secrets.OCI_NAMESPACE }}
        run: npm run build
      - uses: actions/upload-artifact@v4
        with: { name: web-dist, path: dist }

  build-docker:
    name: Build & Push Docker
    needs: data-and-quality
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
        with: { ref: main }
      - uses: docker/login-action@v3
        with: { registry: ${{ secrets.OCI_REGISTRY_URL }}, username: ${{ secrets.OCI_USERNAME }}, password: ${{ secrets.OCI_AUTH_TOKEN }} }
      - uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.OCI_REGISTRY_URL }}/${{ secrets.OCI_NAMESPACE }}/cherryos:latest
          build-args: |
            VITE_PROXY_URL=${{ secrets.VITE_PROXY_URL }}
            VITE_WEATHER_API_KEY=${{ secrets.VITE_WEATHER_API_KEY }}
            VITE_OCI_NAMESPACE=${{ secrets.OCI_NAMESPACE }}

  # 3. Deployment
  deploy:
    name: Deploy to Pages & OCI
    needs: build-web
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
        with: { ref: main }
      - uses: actions/download-artifact@v4
        with: { name: web-dist, path: dist }
      - name: GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with: { github_token: ${{ secrets.GITHUB_TOKEN }}, publish_dir: ./dist }
      - name: OCI Sync
        run: |
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_API_KEY }}" > ~/.oci/oci_api_key.pem
          cat <<EOF > ~/.oci/config
          [DEFAULT]
          user=${{ secrets.OCI_USER_OCID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_TENANCY_OCID }}
          region=${{ secrets.OCI_REGION }}
          key_file=~/.oci/oci_api_key.pem
          EOF
          bash -c "$(curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh)" -- --accept-all-defaults
          /home/runner/bin/oci os object bulk-upload -ns ${{ secrets.OCI_NAMESPACE }} -bn cherryos-deploy-prod --src-dir ./dist --overwrite
